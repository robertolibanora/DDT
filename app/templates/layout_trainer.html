{% extends "base.html" %}

{% block title %}Insegna Layout DDT{% endblock %}

{% block header_title %}âœï¸ Insegna Layout DDT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/layout_trainer.css">
{% endblock %}

{% block content %}
    <div id="message" class="message hidden"></div>
    
    <div class="instructions">
        <h3>ğŸ“– Istruzioni</h3>
        <ul>
            <li><strong>Carica un PDF</strong> oppure usa un documento dall'anteprima</li>
            <li><strong>Seleziona un campo</strong> dal menu a tendina</li>
            <li><strong>Disegna un rettangolo</strong> sull'immagine per indicare dove si trova quel campo</li>
            <li><strong>Clicca su un box</strong> per selezionarlo e modificarlo</li>
            <li><strong>Trascina gli angoli</strong> per ridimensionare un box selezionato</li>
            <li><strong>Trascina il box</strong> per spostarlo</li>
            <li><strong>Premi Canc</strong> per eliminare un box selezionato</li>
            <li><strong>Inserisci il nome del fornitore</strong> e salva il layout</li>
        </ul>
        <p><strong>âš ï¸ Importante:</strong> Le coordinate sono salvate in percentuale, quindi la regola funzionerÃ  per documenti con lo stesso layout anche se di dimensioni diverse.</p>
    </div>
    
    <div class="upload-section">
        <h3>ğŸ“¤ Carica PDF</h3>
        <form id="upload-form" enctype="multipart/form-data">
            <div class="upload-form-group">
                <label for="pdf-file-input">Seleziona un file DDT (PDF)</label>
                <input 
                    type="file" 
                    id="pdf-file-input" 
                    name="file" 
                    accept="application/pdf"
                >
                <small class="form-help">Solo file PDF sono supportati. Massimo 10MB.</small>
            </div>
            <button type="submit" class="btn-upload" id="btn-upload-pdf">
                <span id="upload-btn-text">ğŸ“¤ Carica e Genera Anteprima</span>
                <span id="upload-btn-spinner" class="spinner hidden"></span>
            </button>
        </form>
    </div>
    
    <div class="layout-trainer-container">
        <div class="layout-canvas-section">
            <h3>ğŸ“„ Anteprima Documento</h3>
            <div id="canvas-container" style="display: none;">
                <canvas id="layout-canvas"></canvas>
                <p style="margin-top: 10px; color: #666; font-size: 12px;">
                    Disegna i box per indicare dove si trovano i campi nel documento
                </p>
            </div>
            <div id="no-image-message" style="padding: 40px; text-align: center; color: #999; background: var(--sand-light); border-radius: 8px; border: 2px dashed var(--aqua-light);">
                <p style="font-size: 1.1em; margin-bottom: 10px;">ğŸ“„ Nessun documento caricato</p>
                <p style="font-size: 0.9em;">Carica un PDF usando il form sopra oppure apri questa pagina dall'anteprima di un DDT</p>
            </div>
        </div>
        
        <div class="layout-controls-section">
            <h3>âš™ï¸ Controlli</h3>
            
            <div class="supplier-input-group">
                <label for="supplier-input">Fornitore (Mittente):</label>
                <input type="text" id="supplier-input" placeholder="Es: FIORITAL" required>
            </div>
            
            <div class="rule-name-input-group">
                <label for="rule-name-input">Nome Regola:</label>
                <input type="text" id="rule-name-input" placeholder="Es: FIORITAL_layout_v1" required>
            </div>
            
            <div class="field-select-group">
                <label for="field-select">Seleziona Campo:</label>
                <select id="field-select">
                    <option value="">-- Seleziona un campo --</option>
                    <option value="mittente">Mittente</option>
                    <option value="destinatario">Destinatario</option>
                    <option value="data">Data</option>
                    <option value="numero_documento">Numero Documento</option>
                    <option value="totale_kg">Totale Kg</option>
                </select>
            </div>
            
            <div>
                <h4>Box Definiti:</h4>
                <ul id="boxes-list" class="boxes-list">
                    <li style="color: #999; font-style: italic; padding: 12px; background: var(--sand-light); border-radius: 6px;">Nessun box definito</li>
                </ul>
            </div>
            
            <div class="action-buttons">
                <button class="btn-save" id="btn-save-layout">ğŸ’¾ Salva Layout</button>
                <button class="btn-clear" id="btn-clear-all">ğŸ—‘ï¸ Elimina Tutti i Box</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="/static/js/layout_trainer.js"></script>
    <script>
        let imageUrl = null;
        let fileHash = null;
        let supplier = null;
        
        function showMessage(text, type = 'info') {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type}`;
            message.classList.remove('hidden');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    message.classList.add('hidden');
                }, 5000);
            }
        }
        
        function loadImageFromUrl(url, hash) {
            fileHash = hash;
            imageUrl = url;
            
            // Mostra il canvas e nascondi il messaggio
            document.getElementById('canvas-container').style.display = 'block';
            document.getElementById('no-image-message').style.display = 'none';
            
            // Carica immagine
            layoutTrainer.loadImage(imageUrl).then(() => {
                console.log('Immagine caricata');
                showMessage('âœ… Immagine caricata con successo', 'success');
            }).catch(err => {
                console.error('Errore caricamento immagine:', err);
                showMessage('Errore caricamento immagine', 'error');
            });
        }
        
        // Gestione upload file
        const uploadForm = document.getElementById('upload-form');
        const uploadBtn = document.getElementById('btn-upload-pdf');
        const uploadBtnText = document.getElementById('upload-btn-text');
        const uploadBtnSpinner = document.getElementById('upload-btn-spinner');
        const fileInput = document.getElementById('pdf-file-input');
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) {
                showMessage('âš ï¸ Seleziona un file PDF', 'error');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showMessage('âš ï¸ Il file deve essere un PDF', 'error');
                return;
            }
            
            // Disabilita il pulsante e mostra spinner
            uploadBtn.disabled = true;
            uploadBtnText.textContent = 'â³ Caricamento in corso...';
            uploadBtnSpinner.classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/layout/upload-preview', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Carica l'immagine nel canvas
                    loadImageFromUrl(data.image_url, data.file_hash);
                    showMessage(`âœ… File caricato: ${data.file_name}`, 'success');
                } else {
                    showMessage(`âŒ Errore: ${data.detail || 'Errore durante il caricamento'}`, 'error');
                }
            } catch (error) {
                console.error('Errore upload:', error);
                showMessage(`âŒ Errore durante il caricamento: ${error.message}`, 'error');
            } finally {
                // Riabilita il pulsante
                uploadBtn.disabled = false;
                uploadBtnText.textContent = 'ğŸ“¤ Carica e Genera Anteprima';
                uploadBtnSpinner.classList.add('hidden');
            }
        });
        
        // Carica immagine se fornita come parametro URL
        const urlParams = new URLSearchParams(window.location.search);
        const hashParam = urlParams.get('hash');
        const supplierParam = urlParams.get('supplier');
        
        if (hashParam) {
            fileHash = hashParam;
            imageUrl = `/preview/image/${hashParam}`;
            supplier = supplierParam || '';
            
            // Precompila il campo fornitore se disponibile
            if (supplier) {
                document.getElementById('supplier-input').value = supplier;
            }
            
            // Genera nome regola automatico
            const ruleName = supplier ? `${supplier.toUpperCase().replace(/[^A-Z0-9]/g, '_')}_layout_v1` : 'layout_v1';
            document.getElementById('rule-name-input').value = ruleName;
            
            // Carica immagine
            loadImageFromUrl(imageUrl, hashParam);
        }
        
        document.getElementById('btn-save-layout').addEventListener('click', async () => {
            const supplierInput = document.getElementById('supplier-input').value.trim();
            const ruleNameInput = document.getElementById('rule-name-input').value.trim();
            
            if (!supplierInput) {
                showMessage('âš ï¸ Inserisci il nome del fornitore', 'error');
                return;
            }
            
            if (!ruleNameInput) {
                showMessage('âš ï¸ Inserisci il nome della regola', 'error');
                return;
            }
            
            if (layoutTrainer.boxes.length === 0) {
                showMessage('âš ï¸ Definisci almeno un box per salvare il layout', 'error');
                return;
            }
            
            const fields = layoutTrainer.getFieldsData();
            
            // Valida che non ci siano campi duplicati
            const fieldNames = Object.keys(fields);
            if (new Set(fieldNames).size !== fieldNames.length) {
                showMessage('âš ï¸ Non puoi definire piÃ¹ box per lo stesso campo', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('rule_name', ruleNameInput);
            formData.append('supplier', supplierInput);
            formData.append('page_count', '1'); // Per ora solo pagina 1
            formData.append('fields', JSON.stringify(fields));
            
            try {
                const response = await fetch('/api/layout/rules/save', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showMessage(`âœ… Layout salvato con successo: ${ruleNameInput}`, 'success');
                    setTimeout(() => {
                        window.location.href = '/rules';
                    }, 2000);
                } else {
                    showMessage(`âŒ Errore: ${data.detail || 'Errore sconosciuto'}`, 'error');
                }
            } catch (error) {
                console.error('Errore salvataggio layout:', error);
                showMessage(`âŒ Errore durante il salvataggio: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('btn-clear-all').addEventListener('click', () => {
            layoutTrainer.clearAll();
        });
    </script>
{% endblock %}
